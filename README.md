# IL accelerator

Generic helm chart capable of rendering any number of applications dynamically (as long as they are defined in values-apps.yaml)

In order to render the template please use the following command:

```helm template --namespace xyz --set global.tag=xyz-123 -f ./ops/k8s/helm/application/values-common.yaml -f ./ops/k8s/helm/application/values-apps.yaml ./ops/k8s/helm/application```

Chart can easily be migrated between potential self contained systems allowing deployment of just a group of microservices. This will ensure proper versioning for a specific set of microservices without any need of rerolling entire namespace during upgrades.

For installing the chart run the following command (with optional --dry-run to allow kubernetes to validate rendered yamls)
Subsitute namespace name, tag and application name (in test scenario it' 'custom-app' ) with any that fit your use case.

```helm upgrade --install --namespace xyz --set global.tag=xyz-123 -f ./ops/k8s/helm/application/values-common.yaml -f ./ops/k8s/helm/application/values-apps.yaml custom-app ./ops/k8s/helm/application (--dry-run)```

## application services:
- api-gateway
- camunda (more info in the service README file)
- demo
- error-handling

## application external system stubs:
- petstore
- sfdc

## exposed HTTP endpoints via `api-gateway` service:
- POST `/pets` (`demo` service -> `petstore` stub)
- POST `/pets/async` (`demo` service -> `internalPets` Kafka topic -> `petstore` stub + `pets` Kafka topic)
- GET `/pets` (`demo` service -> `petstore` stub)
- POST `/accounts/{accountName}` (`demo` service -> `sfdc` stub)
- POST `/orders` (`camunda` service -> `orders` Kafka topic)
- GET `/operations-service/paused-consumers` (`error-handling` service -> ETCD + Kafka)
- POST `/operations-service/paused-consumers/resume` (`error-handling` service -> ETCD + Kafka)

please check the attached Postman collection under `/postman-collection` directory

## auto-generation of Java classes
API models are auto generated by specific Gradle plugins based on the `OpenAPI 3` and `Swagger 2.0` contract specifications defined
in the `yml` files. The generated models are under `/build/generated-src` directory in the related service custom libraries (`/services/libs`):
- `api-models`
- `petstore-models`
- `sfdc-models`

The `Avro` schemas and classes for the Kafka messaging are also auto-generated based on the previously generated Java classes. 
Schemas are saved under `avro-schemas` library. The Avro Java models are saved under `avro-models` library.

## application error-handling
The application error-handling mechanism is handled in combination of the two components:
- `error-handling-lib` custom library (imported in other services)
- `error-handling` standalone microservice

There are three types of custom errors defined under `exceptions` library:
- `BusinessException`
- `TechnicalException`
- `UnknownException`

There are two types of error-handling mechanism:
- synchronous
  - for regular HTTP response handled by Spring `ControllerAdvice` annotated class (`GlobalControllerExceptionHandler` from the `error-handling-lib`)
- asynchronous
  - for Kafka based flows handled by `GlobalKafkaListenerExceptionErrorHandler` from the `error-handling-lib`
  - async errors are send to the `errors` Kafka topic and handled by the `error-handling` service
  - for `TechicalExceptions` in the async context, there is a `consumer pausing` mechanism implemented. In such case, the messages from the related Kafka topic are not consumed. The offset of the last failed message is kept to retry the processing of this message after the fix.
  - the `error-handling` service exposes two consumer related endpoints to monitor and resume all paused consumers:
    - GET `/operations-service/paused-consumers`
    - POST `/operations-service/paused-consumers/resume`
  - there are also consumer related endpoints exposed in the specific service thanks to the `error-handling-lib` being imported:
    - GET `/consumers`
    - POST `/consumers/{consumer}`
    - DELETE `/consumers/{consumer}`

## local usage
Run the `start-local-env.sh` script under `/ops/local` directory
